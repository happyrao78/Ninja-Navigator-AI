import streamlit as st
import requests
import datetime
from utils.save_to_document import save_document

# Configuration
BASE_URL = "http://localhost:8000"  # FastAPI backend URL

# Page config
st.set_page_config(
    page_title="ğŸ¤– Ninja Navigator AI - Multi-Agent Travel Planner",
    page_icon="âœˆï¸",
    layout="wide"
)

# Header
st.title("ğŸ¤– Ninja Navigator AI")
st.subheader("ğŸŒ Multi-Agent Travel Planning System")

# Sidebar with agent info
with st.sidebar:
    st.header("ğŸ¤– Active Agents")
    
    try:
        agent_response = requests.get(f"{BASE_URL}/agents/status")
        if agent_response.status_code == 200:
            agent_data = agent_response.json()
            st.success(f"âœ… {agent_data['total_agents']} Agents Active")
            
            st.write("**Specialized Agents:**")
            st.write("ğŸ” Research Agent")
            st.write("ğŸŒ¤ï¸ Weather Agent") 
            st.write("ğŸ’° Budget Agent")
            st.write("ğŸ“… Itinerary Agent")
            st.write("ğŸ¯ Coordinator Agent")
        else:
            st.error(" Agents Offline")
    except:
        st.warning(" Connection to agents pending...")

# Main interface
st.write("---")

# Input section
with st.container():
    st.header("âœˆï¸ Plan Your Perfect Trip")
    
    col1, col2 = st.columns([3, 1])
    
    with col1:
        user_input = st.text_area(
            "ğŸ—¨ï¸ Describe your dream trip:",
            placeholder="e.g., Plan a 7-day trip to Tokyo for 2 people with medium budget, interested in culture and food",
            height=100
        )
    
    with col2:
        st.write("**ğŸ’¡ Examples:**")
        st.write("â€¢ Plan a trip to Bali for 5 days")
        st.write("â€¢ Visit Paris for a week")
        st.write("â€¢ 3-day adventure in Dubai")

# Submit button
submit_button = st.button("ğŸš€ Start Multi-Agent Planning", type="primary", use_container_width=True)

# Response section
if submit_button and user_input.strip():
    
    # Show loading with agent status
    with st.spinner("ğŸ¤– Multi-Agent System Working..."):
        st.info("ğŸ“Š Research Agent analyzing destination...")
        st.info("ğŸŒ¤ï¸ Weather Agent checking forecast...")
        st.info("ğŸ’° Budget Agent calculating costs...")
        st.info("ğŸ“… Itinerary Agent creating schedule...")
        st.info("ğŸ¯ Coordinator Agent finalizing plan...")
        
        try:
            # Make API call
            payload = {"question": user_input}
            response = requests.post(f"{BASE_URL}/query", json=payload)

            if response.status_code == 200:
                data = response.json()
                answer = data.get("answer", "No answer returned.")
                destination_extracted = data.get("destination_extracted", "Unknown")
                agents_involved = data.get("agents_involved", {})
                agent_contributions = data.get("agent_contributions", {})

                
                st.info(f"ğŸ“ Destination Extracted: {destination_extracted}")
                # Success message
                st.success("âœ… Multi-Agent Planning Completed!")
                
                # Show agent contributions
                with st.expander("ğŸ¤– Agent Contributions Summary"):
                    col1, col2, col3 = st.columns(3)
                    
                    with col1:
                        if "research_agent" in agent_contributions:
                            st.write("**ğŸ” Research Agent:**")
                            st.write("âœ… Destination analysis")
                            st.write("âœ… Attractions research")
                    
                    with col2:
                        if "weather_agent" in agent_contributions:
                            st.write("**ğŸŒ¤ï¸ Weather Agent:**")
                            st.write("âœ… Weather forecast")
                            st.write("âœ… Travel advisory")
                    
                    with col3:
                        if "budget_agent" in agent_contributions:
                            st.write("**ğŸ’° Budget Agent:**")
                            st.write("âœ… Cost estimation")
                            st.write("âœ… Budget breakdown")
                    

                
                # Display the main response
                st.write("---")
                st.header("ğŸ“‹ Your Complete Travel Plan")
                
                # Format the response nicely
                markdown_content = f"""
{answer}

---

**ğŸ“Š Generated by Multi-Agent System:**
- ğŸ” Research Agent: Destination analysis & attractions
- ğŸŒ¤ï¸ Weather Agent: Weather forecast & advisory  
- ğŸ’° Budget Agent: Cost estimation & breakdown
- ğŸ“… Itinerary Agent: Day-by-day planning
- ğŸ¯ Coordinator Agent: Plan orchestration

**â° Generated:** {datetime.datetime.now().strftime('%Y-%m-%d at %H:%M')}  
**ğŸ¤– Created by:** Ninja Navigator AI Multi-Agent System

*This travel plan was generated by AI agents. Please verify all information, especially prices, operating hours, and travel requirements before your trip.*
"""
                
                st.markdown(markdown_content)
                
                # Action buttons
                col1, col2 = st.columns([1, 1])
                
                with col1:
                    st.download_button(
                        label="ğŸ“¥ Download Plan",
                        data=markdown_content,
                        file_name=f"travel_plan_{datetime.datetime.now().strftime('%Y%m%d_%H%M%S')}.md",
                        mime="text/markdown"
                    )
                
                with col2:
                    if st.button("ğŸ”„ Plan Another Trip"):
                        st.rerun()

            else:
                st.error(f" Multi-Agent System Error: {response.text}")
                
        except Exception as e:
            st.error(f" Connection Error: {str(e)}")
            st.info("ğŸ’¡ Make sure the backend server is running: `uvicorn main:app --reload`")

# Footer
st.write("---")
st.caption("ğŸ¤– Powered by Ninja Navigator AI Multi-Agent System | ğŸ”§ Built with LangChain, FastAPI & Streamlit | ğŸ‘¨â€ğŸ’» Created by [Happy Yadav](https://www.yadavhappy.in)")